name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: '.'
          format: gcc
          severity: warning

  test-functions:
    name: Test Functions
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run unit tests
        run: |
          chmod +x test/test-functions.sh
          ./test/test-functions.sh

  build-images:
    name: Build ${{ matrix.cli }} Image
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        cli: [claude, vibe, copilot]
    steps:
      - uses: actions/checkout@v4

      - name: Build image
        run: |
          docker build -t ai-sandbox-${{ matrix.cli }}:test \
            -f Dockerfile.${{ matrix.cli }}-sandbox .

      - name: Test image starts
        run: |
          docker run --rm \
            -e CLI_TYPE=${{ matrix.cli }} \
            ai-sandbox-${{ matrix.cli }}:test \
            echo "Container ${{ matrix.cli }} OK"

  test-entrypoint:
    name: Test Entrypoint Services
    runs-on: ubuntu-latest
    needs: build-images
    steps:
      - uses: actions/checkout@v4

      - name: Build Claude image
        run: |
          docker build -t ai-sandbox-claude:test -f Dockerfile.claude-sandbox .

      - name: Test services start
        run: |
          # Start container in background with sleep to keep alive
          docker run -d --name test-container \
            -e CLI_TYPE=claude \
            ai-sandbox-claude:test \
            bash -c "sleep 30"

          # Wait for services to start
          sleep 5

          # Check code-server is running
          if docker exec test-container pgrep -f code-server > /dev/null; then
            echo "✓ code-server running"
          else
            echo "✗ code-server not running"
            exit 1
          fi

          # Check upload-server is running
          if docker exec test-container pgrep -f upload-server > /dev/null; then
            echo "✓ upload-server running"
          else
            echo "✗ upload-server not running"
            exit 1
          fi

          # Cleanup
          docker rm -f test-container
